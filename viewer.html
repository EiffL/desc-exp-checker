<!DOCTYPE html>
<html>
<head>
  <title>DES exposure checker | Viewer</title>
  <link rel="stylesheet" media="screen" href="assets/bootstrap/css/bootstrap.min.css" type="text/css" charset="utf-8">
  <meta charset="utf-8">
  <meta name="author" content="Peter Melchior, Erin Sheldon">
  <link rel="icon" href="assets/DES_logo_trans.png" type="image/png">
  <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if lt IE 9]
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style>
  .container {width: 1024px; }
  body,html { height: 100%; }
  #wrapper {min-height: 100%; height: auto !important; height: 100%; margin: 0 auto -60px;}
  #foot, #push { height: 60px; clear: both; }
  </style>
  <script type="text/javascript" src="assets/fits.js"></script>
  <script type="text/javascript" src="assets/webfits-canvas.0.3.1.js"></script>
  <script type="text/javascript">
  var webfits = null;
  var extent = null;
  var dataextent = null;
  var stretch = "arcsinh";
  var spinner;
  var marks = [];
  var problem = null;
  var fileid = null;
  var images_per_fp = 61;
  
  function overlayCallback(_this, opts, evt) {
    if (problem !== null) {
      // add circle around dbl-clicked location
      var ctx = _this.overlayCtx;
      var rect = _this.canvas.getBoundingClientRect();
      var prob = {
        x: (evt.clientX - rect.left + 0.5), // for unknown reasons, there is a 0.5 pixel shift in rect.left/right
        y: (evt.clientY - rect.top),
        problem: problem,
        detail: $('#problem-text').val() == "" ? null : $('#problem-text').val()
      };
      marks.push(prob);
      ctx.beginPath();
      ctx.arc(prob.x, prob.y, 50, 0, 2*Math.PI, true);
      ctx.lineWidth=2;
      ctx.strokeStyle='#FF0000';
      ctx.stroke();
      
      ctx.font = '12pt Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#FF0000';
      ctx.fillText(prob.problem, prob.x, prob.y);
      
      // remove "mark the image" text and show the save/clear buttons instead
      $('#problem-dialogue').addClass('hide');
      $('#mark-buttons').removeClass('hide');
    }
  }
  
  function clearMarks() {
    webfits.overlayCtx.clearRect(0,0,webfits.canvas.width, webfits.canvas.height);
    marks = [];
  }

  // Define callback to be executed after image is received from the server
  function getImage(f, opts) {
    // Get image data unit
    var dataunit = f.getDataUnit(2);
    // Set options to pass to the next callback
    opts["dataunit"] = dataunit;
    opts["f"] = f;
    // Asynchronously get pixels representing the image passing a callback and options
    dataunit.getFrameAsync(0, createVisualization, opts);
  }
  
  // Define callback for when pixels have been read from file
  function createVisualization(arr, opts) {
    
    var dataunit = opts.dataunit;
    
    //var dataunit = opts.dataunit;
    var width = dataunit.width;
    var height = dataunit.height;
    dataextent = dataunit.getExtent(arr);
    
    // Get the DOM element
    var el = $('#' + opts.el).get(0);
    
    var callbacks = {
      onclick: overlayCallback
    };
    // Initialize the WebFITS context with a viewer of size width
    if (webfits === null) {
      webfits = new astro.WebFITS(el,width, height);
      // Add pan and zoom controls
      webfits.setupControls(callbacks, opts);
      extent = $.extend(true, [], dataextent); // fancy for: deep copy of dataextent
      
      // set the vmin, vmax from extent
      $('#vmin-input').val(extent[0]);
      $('#vmax-input').val(extent[1]);
    }
    
    // Load array representation of image
    webfits.loadImage('exposure', arr, width, height);
    
    // Set the intensity range and stretch
    webfits.setExtent(extent[0], extent[1]);
    webfits.setStretch(stretch);
    
    // add weight/bad-pixel map
    var dataunit = opts.f.getDataUnit(3);
    // Set options to pass to the next callback
    opts["dataunit"] = dataunit;
    // Asynchronously get pixels representing the image passing a callback and options
    dataunit.getFrameAsync(0, addMaskLayer, opts);

  }
  
  function addMaskLayer(arr, opts) {
    webfits.loadImage('bpm', arr, 1024, 512);
    webfits.draw();
    $('#loading').addClass('hide');
  }

  function renderImage(name) {
    $('#loading').removeClass('hide');
    if (marks.length)
      clearMarks();
    var opts = {
      el: 'wicked-science-visualization'
    };
    var f = new astro.FITS.File(name, getImage, opts); 
  }
  
    function setNextImage(response) {
    fileid = response.rowid;
    $('#image_name').html(response.expname + ', CCD ' + response.ccd + ", " + response.band + "-band");
    $('#share-url').val('http://' + window.location.host + window.location.pathname + '?expname=' + response.expname + '&ccd=' + response.ccd + "&band=" + response.band);
    renderImage(response.name);
  }
  
  function sendResponse() {
    // post to DB
    $.post('db.php',
           {'fileid': fileid, 'problems': marks},
           function(data) {
            var response = $.parseJSON(data);
            setNextImage(response);
          }
    )
    .fail(function() {
      alert('Failure when saving response');
      clearMarks();
    });
    
    // clear UI
    $("#problem-dialogue").addClass("hide");
    $('#mark-buttons').addClass('hide');
    $('#problem-text').val('');
    $('#problem-name').html('Problem');
    problem = null;
  }
  
  function userClass(total_files) {
    // frequent users: color badge acording to # of focal planes done
    if (total_files / images_per_fp >= 100)
      return {class: 5, style: 'badge-inverse', title: 'Chief inspector'};
    if (total_files / images_per_fp >= 10)
      return {class: 4, style: 'badge-info', title: 'Veteran'};
    if (total_files / images_per_fp >= 5)
      return {class: 3, style: 'badge-important', title: 'Top performer'};
    if (total_files / images_per_fp >= 1)
      return {class: 2, style: 'badge-warning', title: 'Frequent checker'};
    if (total_files >= 10)
      return {class: 1, style: 'badge-success', title: 'Rookie'};
    return {class: 0};
  }
  
  function missingFilesForNextClass(total_files, userclass) {
    switch(userclass.class) {
      case 0: return 10 - total_files;
      case 1: return images_per_fp - total_files;
      case 2: return 5*images_per_fp - total_files;
      case 3: return 10*images_per_fp - total_files;
      case 4: return 100*images_per_fp - total_files;
    }
  }
  
  function setBadgeColor(userClass) {
    if (userClass.class > 0)
      $('#userrank').addClass(userClass.style);
  }
  
  function numberSuffix(number) {
    if (number == 1)
      return number + "st";
    if (number == 2)
      return number + "nd";
    if (number == 3)
      return number + "rd";
    return number + "th";
  }
  
  function checkFileCount(total_files) {
    var uc = userClass(total_files);
    setBadgeColor(uc);
    if (total_files % images_per_fp == 0) {
      var fps = total_files/images_per_fp;
      $('#fp_number').html(numberSuffix(fps));
      var old_uc = userClass(total_files-1);
      if (uc.class > old_uc.class) {
        $('#congrats_details').html("To reflect your achievements, we've upgraded you to <span class='badge " + uc.style + "'>" + uc.title + "</span> status.");
        $('#userrank').removeClass(old_uc.style);
      }
      else
        $('#congrats_details').html();
      $('#congrats-modal').modal('show');
    }
    
  }
  
  function checkSessionCookie() {
    return ($.cookie('sid') != null);    
  }

  function kickOut() {
    $('#session-modal').modal('show');
    setTimeout(function() {
      // kick out
      window.location.href = "index.html";
    }, 3000);
  }
  
  function getMyData() {
    $.get('mydata.php', function(response) {
      // check if server has just invalidated session
      if (!checkSessionCookie())
        kickOut();
      
      $('#username').html(response.username);
      $('#userrank').html("#"+response.rank);
      $('#user-rank').html("#"+response.rank);
      setBadgeColor(userClass(response.total_files));
      $('#total-files').html(response.total_files);
      $('#flagged-files').html(response.flagged_files);
      $('#user-menu').removeClass('hide');
      var uc = userClass(response.total_files);
      var rankDetails = "";
      if (uc.class > 0)
        rankDetails += "You have the rank of a <span class='badge " + uc.style + "'>" + uc.title + "</span>.<br />";
      if (uc.class < 5) {
        var missing = missingFilesForNextClass(response.total_files, uc);
        var next_uc = userClass(parseInt(response.total_files) + missing);
        rankDetails += "You need another <strong>" + missing + "</strong> images to reach the rank of a <span class='badge " + next_uc.style + "'>" + next_uc.title + "</span>.";
      }
      $('#user_rank_details').html(rankDetails);
    }, 'json');
  }
  </script>
</head>

<body>
  <div id="wrapper">
  <div class='container'>
    <div class="navbar">
      <div class="navbar-inner">
	<a class="brand" href="index.html">DES exposure checker</a>
	<ul class="nav">
          <li class="active"><a href="#">Viewer</a></li>
	  <li><a href="tutorial.html">Tutorial</a></li>
          <li><a href="statistics.html">Statistics</a></li>
	</ul>
        <ul class="nav pull-right hide" id="user-menu" style="margin-right:-20px">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span id="username">Username</span> <span class="badge" id="userrank">#1</span>
            <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li><a tabindex="-1" href="#" id="mystats-anchor">My statistics</a></li>
              <li><a tabindex="-1" href="#" id="leaderboard-anchor">Leaderboard</a></li>
              <li class="divider"></li>
              <li><a tabindex="-1" id="logout" href="#">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div> 
    </div>
    
    <div style="margin-top:20px; position:relative;">
      <button id="fine-button" class="btn btn-success send">Next</button>
      <div class="btn-group">
        <button id="problem-button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown"><span id="problem-name">Problem</span>
        <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
          <li><a class="problem" tabindex="-1" href="#">Cosmic ray</a></li>
          <li><a class="problem" tabindex="-1" href="#">Ghost</a></li>
          <li><a class="problem" tabindex="-1" href="#">Cross-talk</a></li>
          <li><a class="problem" tabindex="-1" href="#">Satellite</a></li>
          <li><a class="problem" tabindex="-1" href="#">Readout</a></li>
          <li><a class="problem" tabindex="-1" href="#">Failure</a></li>
          <li class="divider"></li>
          <li><a tabindex="-1" class="problem" id="other-problem" href="#">Other...</a></li>
        </ul>
      </div>
      <span id="problem-dialogue" class="hide" style="margin-left: 10px;font-weight:bold;">
        Click to mark problem(s) in image
      </span>
      <span id="mark-buttons" class="hide" style="margin-left: 10px;">
        <button class="btn btn-info" id="clear-button">Clear</button>
      </span>
      <span style="position:absolute; right: 0px; top:0px;">
        <span class="muted" id="image_name"></span>
        <button style="margin-left:10px;" class="btn btn-info" href="#" id="share-button">Share <u>l</u>ink</button>
        <button class="btn btn-info" href="#" id="toggle-mask-button">Toggle <u>m</u>ask</button>
        <button class="btn btn-info" href="#" id="option-button"><u>D</u>isplay options</button>
      </span>
    </div>
    
    <div id="loading" class="hide" style="position:relative; left:512px; top:266px; z-index:1000;"></div>
    <div id="wicked-science-visualization" style="margin: 10px 0px; height:512px; width: 1024px; background-color:#CCCCCC;"></div>
    
    <div class="modal hide" id="problem-modal">
      <div class="modal-header">
        <h3>Describe the problem</h3>
      </div>
      <div class="modal-body">
        <textarea style="width:516px;" type="text" id="problem-text" placeholder="Describe in your own words"></textarea>
      </div>
      <div class="modal-footer">
        <span style="padding-right:20px">When done, click on the image to mark the problematic area</span>
        <button id="problem-text-button" class="btn btn-primary">Done</button>
      </div>
    </div>
    <div class="modal hide" id="control-modal" tabindex="-1">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <form class="form-horizontal">
          <fieldset>
            <legend>Scaling</legend>
            <button id="linear-button" class="btn btn-small stretch">Linear</button>
            <button id="sqrt-button" class="btn btn-small stretch">Sqrt</button>
            <button id="logarithm-button" class="btn btn-small stretch">Logarithmic</button>
            <button id="arcsinh-button" class="btn btn-small stretch"><u>A</u>rcSinh</button>
            <button id="peter-button" class="btn btn-small stretch"><u>P</u>eter's</button>
          </fieldset>
          <fieldset>
            <legend>Visible data range</legend>
            <input type="text" class="input-small range" placeholder="Minimum" id="vmin-input">
            <input type="text" class="input-small range" placeholder="Maximum" id="vmax-input">
            <button id="vmin-max-button" class="btn btn-small range">Update</button>
            <button id="vmin-max-reset-button" class="btn btn-small range">Reset</button>
          </fieldset>
        </form>
      </div>
    </div>
    
    <div class="modal hide" id="mystats-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>My statistics</h3>
      </div>
      <div class="modal-body">
        <p>You've checked a total of <strong id="total-files"></strong> images
        and found <strong id="flagged-files"></strong> of them problematic.<br />
        You are currently at position <strong id="user-rank"></strong> of the leaderboard.
        </p>
        <p id="user_rank_details"></p>
      </div>
    </div>

    <div class="modal hide" id="rank-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Leaderboard</h3>
      </div>
      <div class="modal-body"></div>
    </div>
    <div class="modal hide" id="congrats-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Congratulations</h3>
      </div>
      <div class="modal-body">
        <p>You have just finished your <strong id="fp_number"></strong> focal plane.</p>
        <p id="congrats_details"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-dismiss="modal">Keep going!</button>
      </div>
    </div>
    
    <div class="modal hide" id="share-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>URL for sharing</h3>
      </div>
      <div class="modal-body">
        <textarea style="width:516px;" type="text" id="share-url" disabled></textarea>
      </div>
    </div>
    
    <div class="modal hide" id="session-modal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Login required</h3>
      </div>
      <div class="modal-body">
        <p>To view this page, you need to log in. If you've done that, your session
        may be expired. Either way, please log in (again)...</p>
      </div>
    </div>
    
  </div>
  <div id="push"></div>
  </div>
  <div id="foot">
    <div class="container" style="text-align:right">
      <div class="breadcrumb muted" style="margin: 24px 0 0 0;">Created by Peter Melchior and Erin Sheldon</div>
    </div>
  </div>
</body>
<script type="text/javascript" src="assets/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="assets/jquery.cookie.js"></script>
<script type="text/javascript" src="assets/jwerty.js"></script>
<script type="text/javascript" src="assets/purl.js"></script>
<script type="text/javascript" src="assets/spin.min.js"></script>
<script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
<script>
  $(document).ready(function(){
    if (!checkSessionCookie())
        kickOut();
        
    spinner = new Spinner({color: "#049cdb"}).spin();
    $('#loading').append(spinner.el);
    // get first image data
    $.get('db.php', $.url().param(), function(data) {
            var response = $.parseJSON(data);
            setNextImage(response);
          }
    )
    .fail(function() {
      alert('Failure when loading image');
    });

    $('#' + stretch + "-button").addClass('btn-primary');
    getMyData();
    setInterval(getMyData, 600000);
  });
  $('button[class*="send"]').on('click', function(evt) {
    sendResponse();
  });
  $('button[class*="stretch"]').on('click', function(evt) {
    // toggle primary class as indicator for current stretch
    $('#' + stretch + "-button").removeClass('btn-primary');
    stretch = evt.target.id.split("-").shift();
    $('#' + stretch + "-button").addClass('btn-primary');
    webfits.setStretch(stretch);
  });
  $('#vmin-max-button').on('click', function() {
    extent = [$('#vmin-input').val(), $('#vmax-input').val()];
    webfits.setExtent(extent[0], extent[1]);
  });
  $('#vmin-max-reset-button').on('click', function() {
    extent[0] = dataextent[0];
    extent[1] = dataextent[1];
    $('#vmin-input').val(extent[0]);
    $('#vmax-input').val(extent[1]);
    webfits.setExtent(extent[0], extent[1]);
  });
  $('form').submit(function() {
    return false;
  });
  $('#control-modal').modal({"backdrop": false, "show": false, "keyboard": true});
  $('#problem-modal').modal({"backdrop": false, "show": false, "keyboard": false });
  $('#share-modal').modal({"backdrop": false, "show": false, "keyboard": true });
  $('#share-button').on('click', function() {
    $('#share-modal').modal('show');
    var textBox = $('#share-url');
    textBox.select();
    // Work around Chrome's little problem
    textBox.onmouseup = function() {
      // Prevent further mouseup intervention
      textBox.onmouseup = null;
      return false;
    };
  });
  $('#toggle-mask-button').on('click', function() {
    webfits.showMask = !webfits.showMask;
    webfits.draw();
  });
  $('#option-button').on('click', function() {
    $('#control-modal').modal('show');
  });
  $('#problem-text-button').on('click', function() {
    $('#problem-modal').modal('hide');
    var problemName = $('#problem-text').val();
    if (problemName.length > 11)
      problemName = problemName.substring(0,8) + "...";
    $('#problem-name').html(problemName);
  });
  $('a[class*="problem"]').on('click', function(evt) {
    if (problem === null)
      $("#problem-dialogue").removeClass("hide");
    problem = evt.target.innerHTML;
    $('#problem-name').html(problem);
    if (problem == "Other...") {
      $('#problem-modal').modal('show');
    } else {
      $('#problem-text').val('');
    }
  });
  $('#clear-button').on('click', function() {
    clearMarks();
    $('#mark-buttons').addClass('hide');
    $('#problem-dialogue').removeClass('hide');
  });
  
  $('#rank-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#mystats-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#mystats-anchor').on('click', function() {
    getMyData();
    $('#mystats-modal').modal('show');
  });
  $('#congrats-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#leaderboard-anchor').on('click', function() {
    $.get('ranking.php', {'output': 'html'}, function(response) {
      $('#rank-modal').find('[class*="modal-body"]').html(response);
      $('#rank-modal').modal('show');
    });
  });
  $('#logout').on('click', function() {
    $.post('login.php',{'logout':true}, function() {
      window.location.href="index.html";
      });
  });
  $('#session-modal').modal({"backdrop": true, "show":false, "keyboard": false});
  // key bindings
  jwerty.key('alt+l', function() {
    $('#share-button').trigger('click');  
  });
  jwerty.key('alt+m', function() {
    $('#toggle-mask-button').trigger('click');  
  });
  jwerty.key('alt+d', function() {
    $('#option-button').trigger('click'); 
  });
  jwerty.key('alt+p', function() {
    $('#peter-button').trigger('click');
  });
  jwerty.key('alt+a', function() {
    $('#arcsinh-button').trigger('click');
  });
</script>
</html>

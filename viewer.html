<!DOCTYPE html>
<html>
<head>
  <title>DES exposure checker | Viewer</title>
  <link rel="stylesheet" media="screen" href="assets/bootstrap/css/bootstrap.min.css" type="text/css" charset="utf-8">
  <link rel="stylesheet" media="screen" href="assets/eyeball.css" type="text/css" charset="utf-8">
  <meta charset="utf-8">
  <meta name="author" content="Peter Melchior, Erin Sheldon">
  <link rel="icon" href="assets/DES_logo_trans.png" type="image/png">
  <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if lt IE 9]
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script type="text/javascript" src="assets/fits.js"></script>
  <script type="text/javascript" src="assets/webfits-canvas.0.3.1.js"></script>
  <script type="text/javascript" src="assets/viewer.js"></script>
</head>

<body>
  <div id="wrapper">
  <div class='container'>
    <!-- NAVBAR -->
    <div class="navbar">
      <div class="navbar-inner">
	<a class="brand" href="index.html">DES exposure checker</a>
	<ul class="nav">
          <li class="active"><a href="#">Viewer</a></li>
	  <li><a href="tutorial.html">Tutorial</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="statistics.html">Statistics</a></li>
          <li><a href="api.html">API</a></li>
          <li><a href="gallery.html">Gallery</a></li>
	</ul>
        <ul class="nav pull-right hide" id="user-menu" style="margin-right:-20px">
          <li id="mydata-li" class="dropdown" style="display: none">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span id="username">Username</span> <span class="badge" id="userrank">#1</span>
            <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li><a tabindex="-1" href="#" id="mystats-anchor">My statistics</a></li>
              <li><a tabindex="-1" href="#" id="leaderboard-anchor">Leaderboard</a></li>
              <li>
                <div class="btn-group" id="release-switch" style="margin:0; padding:3px 20px">
                  <button class="btn btn-small release-button" id="release-button-SVA1">SVA1</button>
                  <button class="btn btn-small release-button" id="release-button-Y1A1">Y1A1</button>
                </div>
              </li>
              <li class="divider"></li>
              <li><a tabindex="-1" id="logout" href="#">Logout</a></li>
            </ul>
          </li>
          <li id="login-li"><a href="index.html" class="login-trigger">Log in ...</a></li>
        </ul>
      </div> 
    </div>
    
    <!-- BUTTONS -->
    <div style="margin-top:20px; position:relative;">
      <button id="fine-button" class="btn btn-success send">Next</button>
      <!--#include file="problem_selector.shtml"-->
      <span id="mark-buttons" class="hide" style="margin-left: 10px;">
        <button class="btn btn-info" id="clear-button">Clear Last</button>
      </span>
      <span style="position:absolute; right: 0px; top:0px;">
        <span class="muted" id="image_name"></span>
        <div class="btn-group" style="margin-left:10px;">
          <button id="info-button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">Info</span>
          <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li><a tabindex="-1" href="#" id="share-button">Share <u>l</u>ink</a></li>
            <li><a tabindex="-1" href="#" id="desdm-button"><u>D</u>ownload image from DESDM</a></li>
            <li><a tabindex="-1" href="#" id="fov-button">Show entire <u>F</u>oV</a></li>
            <li><a tabindex="-1" href="#" id="reported-button">Show reported <u>p</u>roblems</a></li>
          </ul>
        </div>
        <button class="btn btn-info" href="#" id="toggle-mask-button">Toggle <u>m</u>ask</button>
        <button class="btn btn-info" href="#" id="scaling-button">Toggle <u>s</u>caling</button>
      </span>
    </div>
    
    <!-- IMAGE -->
    <div id="loading" class="hide" style="position:relative; left:512px; top:266px; z-index:1000; width:48px;"></div>
    <div id="wicked-science-visualization" style="margin: 10px 0px; height:512px; width: 1024px; background-color:#CCCCCC;"></div>
    
    <!-- MODALS -->
    <div class="modal hide" id="problem-modal">
      <div class="modal-header">
        <button type="button" class="close" id="problem-close-button">&times;</button>
        <h3>Describe what you see</h3>
      </div>
      <div class="modal-body">
        <textarea style="width:516px;" type="text" id="problem-text" placeholder="Describe in your own words. Be as specific as you see fit."></textarea>
      </div>
      <div class="modal-footer">
        <span style="padding-right:20px">When done, click on the image to mark the problematic area</span>
        <button id="problem-text-button" class="btn btn-primary">Done</button>
      </div>
    </div>
    
    <div class="modal hide" id="fov-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Field-of-View image</h3>
      </div>
      <div class="modal-body" style="max-height:none;"><div id="fov-body"></div>
        <map name="ccdmap">
          <area class="ccdshape" shape="rect" coords="151.43,416.17,227.14,454.00" title="CCD 1" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,416.17,302.86,454.00" title="CCD 2" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,416.17,378.57,454.00" title="CCD 3" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,378.33,189.29,416.17" title="CCD 4" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,378.33,265.00,416.17" title="CCD 5" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,378.33,340.71,416.17" title="CCD 6" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,378.33,416.43,416.17" title="CCD 7" href="#">
          <area class="ccdshape" shape="rect" coords="75.71,340.50,151.43,378.33" title="CCD 8" href="#">
          <area class="ccdshape" shape="rect" coords="151.43,340.50,227.14,378.33" title="CCD 9" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,340.50,302.86,378.33" title="CCD 10" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,340.50,378.57,378.33" title="CCD 11" href="#">
          <area class="ccdshape" shape="rect" coords="378.57,340.50,454.29,378.33" title="CCD 12" href="#">
          <area class="ccdshape" shape="rect" coords="37.86,302.67,113.57,340.50" title="CCD 13" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,302.67,189.29,340.50" title="CCD 14" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,302.67,265.00,340.50" title="CCD 15" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,302.67,340.71,340.50" title="CCD 16" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,302.67,416.43,340.50" title="CCD 17" href="#">
          <area class="ccdshape" shape="rect" coords="416.43,302.67,492.14,340.50" title="CCD 18" href="#">
          <area class="ccdshape" shape="rect" coords="37.86,264.83,113.57,302.67" title="CCD 19" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,264.83,189.29,302.67" title="CCD 20" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,264.83,265.00,302.67" title="CCD 21" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,264.83,340.71,302.67" title="CCD 22" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,264.83,416.43,302.67" title="CCD 23" href="#">
          <area class="ccdshape" shape="rect" coords="416.43,264.83,492.14,302.67" title="CCD 24" href="#">
          <area class="ccdshape" shape="rect" coords="0.00,227.00,75.71,264.83" title="CCD 25" href="#">
          <area class="ccdshape" shape="rect" coords="75.71,227.00,151.43,264.83" title="CCD 26" href="#">
          <area class="ccdshape" shape="rect" coords="151.43,227.00,227.14,264.83" title="CCD 27" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,227.00,302.86,264.83" title="CCD 28" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,227.00,378.57,264.83" title="CCD 29" href="#">
          <area class="ccdshape" shape="rect" coords="378.57,227.00,454.29,264.83" title="CCD 30" href="#">
          <area class="ccdshape" shape="rect" coords="454.29,227.00,530.00,264.83" title="CCD 31" href="#">
          <area class="ccdshape" shape="rect" coords="0.00,189.17,75.71,227.00" title="CCD 32" href="#">
          <area class="ccdshape" shape="rect" coords="75.71,189.17,151.43,227.00" title="CCD 33" href="#">
          <area class="ccdshape" shape="rect" coords="151.43,189.17,227.14,227.00" title="CCD 34" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,189.17,302.86,227.00" title="CCD 35" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,189.17,378.57,227.00" title="CCD 36" href="#">
          <area class="ccdshape" shape="rect" coords="378.57,189.17,454.29,227.00" title="CCD 37" href="#">
          <area class="ccdshape" shape="rect" coords="454.29,189.17,530.00,227.00" title="CCD 38" href="#">
          <area class="ccdshape" shape="rect" coords="37.86,151.33,113.57,189.17" title="CCD 39" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,151.33,189.29,189.17" title="CCD 40" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,151.33,265.00,189.17" title="CCD 41" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,151.33,340.71,189.17" title="CCD 42" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,151.33,416.43,189.17" title="CCD 43" href="#">
          <area class="ccdshape" shape="rect" coords="416.43,151.33,492.14,189.17" title="CCD 44" href="#">
          <area class="ccdshape" shape="rect" coords="37.86,113.50,113.57,151.33" title="CCD 45" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,113.50,189.29,151.33" title="CCD 46" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,113.50,265.00,151.33" title="CCD 47" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,113.50,340.71,151.33" title="CCD 48" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,113.50,416.43,151.33" title="CCD 49" href="#">
          <area class="ccdshape" shape="rect" coords="416.43,113.50,492.14,151.33" title="CCD 50" href="#">
          <area class="ccdshape" shape="rect" coords="75.71,75.67,151.43,113.50" title="CCD 51" href="#">
          <area class="ccdshape" shape="rect" coords="151.43,75.67,227.14,113.50" title="CCD 52" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,75.67,302.86,113.50" title="CCD 53" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,75.67,378.57,113.50" title="CCD 54" href="#">
          <area class="ccdshape" shape="rect" coords="378.57,75.67,454.29,113.50" title="CCD 55" href="#">
          <area class="ccdshape" shape="rect" coords="113.57,37.83,189.29,75.67" title="CCD 56" href="#">
          <area class="ccdshape" shape="rect" coords="189.29,37.83,265.00,75.67" title="CCD 57" href="#">
          <area class="ccdshape" shape="rect" coords="265.00,37.83,340.71,75.67" title="CCD 58" href="#">
          <area class="ccdshape" shape="rect" coords="340.71,37.83,416.43,75.67" title="CCD 59" href="#">
          <area class="ccdshape" shape="rect" coords="151.43,0.00,227.14,37.83" title="CCD 60" href="#">
          <area class="ccdshape" shape="rect" coords="227.14,0.00,302.86,37.83" title="CCD 61" href="#">
          <area class="ccdshape" shape="rect" coords="302.86,0.00,378.57,37.83" title="CCD 62" href="#">
      </map>
      </div>
      <div id="fov-url" class="hide"></div>
      </div>
    </div>
    
    <div class="modal hide" id="mystats-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>My statistics</h3>
      </div>
      <div class="modal-body">
        <p>You've checked a total of <strong id="total-files"></strong> images
        and found <strong id="flagged-files"></strong> of them problematic.<br />
        You are currently at position <strong id="user-rank"></strong> of the leaderboard.
        </p>
        <p id="user_rank_details"></p>
      </div>
    </div>

    <div class="modal hide" id="rank-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Leaderboard</h3>
      </div>
      <div class="modal-body"></div>
    </div>
    
    <div class="modal hide" id="congrats-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Congratulations</h3>
      </div>
      <div class="modal-body">
        <p id="congrats_text"></p>
        <p id="congrats_details"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-dismiss="modal">Keep going!</button>
      </div>
    </div>
    
    <div class="modal hide" id="share-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>URL for sharing</h3>
      </div>
      <div class="modal-body">
        <textarea style="width:516px;" type="text" id="share-url" disabled></textarea>
      </div>
    </div>
    
    <div class="modal hide" id="desdm-modal" tabindex="-1">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>URL for finalcut image from DESDM</h3>
      </div>
      <div class="modal-body">
        <textarea style="width:516px;" type="text" id="desdm-url" disabled></textarea>
      </div>
    </div>
    
    <div class="modal hide" id="login-modal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Login required</h3>
      </div>
      <div class="modal-body">
        <p>To report problems you need to log in with your exposure checker credentials.<br>
        If you've done that, your session may be expired. If you haven't signed up yet, please do so.</p>
        <p>Don't worry, we bring'll you back to this image afterwards.</p>
      </div>
      <div class="modal-footer">
        <a href="index.html" class="btn btn-primary login-trigger">Login...</a>
      </div>
    </div>
    
    <div class="modal hide" id="message-modal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 id="message_header"></h3>
      </div>
      <div class="modal-body">
        <p id="message_text"></p>
        <p id="message_details"></p>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-primary" data-dismiss="modal">OK</a>
      </div>
    </div>
    
  </div>
  <div id="push"></div>
  </div>
  <div id="foot">
    <div class="container" style="text-align:right">
      <div class="breadcrumb muted" style="margin: 24px 0 0 0;">Created by Peter Melchior, Erin Sheldon, Alex Drlica-Wagner</div>
    </div>
  </div>
</body>
<script type="text/javascript" src="assets/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="assets/jquery.cookie.js"></script>
<script type="text/javascript" src="assets/jwerty.js"></script>
<script type="text/javascript" src="assets/purl.js"></script>
<script type="text/javascript" src="assets/spin.min.js"></script>
<script type="text/javascript" src="assets/common.js"></script>
<script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
<script>
  // initial setup
  $(document).ready(function(){
    // define and show spinner
    spinner = new Spinner({color: "#049cdb"}).spin();
    $('#loading').append(spinner.el);
    $('#loading').removeClass('hide');

    var urlparams = $.url().param();
    // if user is logged in: show user dropdown
    if (checkSessionCookie()) {
      getMyData();
      setInterval(getMyData, 600000);
      $('#login-li').hide();
      $('#mydata-li').show();
      // return to last image the user has seen before he logged in
      if ($.cookie('lastfile') !== undefined) {
        urlparams = $.url($.cookie('lastfile')).param();
        $.removeCookie('lastfile');
      }
    }
    else {
      $('#login-modal').modal({"backdrop": true, "show":false, "keyboard": true});
      $('a[class*="login-trigger"]').on('click', function(evt) {
        $.cookie('lastfile', $('#share-url').val(), {expires: 1});
        window.location.href=this.attr('href');
      });
      // is not: show message when user clicks on the problem button
      $('#problem-button').on('click', function(evt) {
        $('#login-modal').modal('show');
        evt.preventDefault();
      });
    }
    
    // set up release
    setRelease($.cookie('default-release'));
    $('button[class*="release-button"]').on('click', function(evt) {
      setRelease(this.id.split("-").pop());
      window.location.reload(true);
    });
    urlparams['release'] = release;
    
    // get first image data
    $.get('db.php', urlparams, function(data) {
        var response = $.parseJSON(data);
        setNextImage(response);
      })
    .fail(function() {
      alert('Failure when loading image');
    });
   
  });
  $('form').submit(function() {
    return false;
  });
  
  // initialize fields and modals
  problem_default = $('#problem-name').html();
  $('#problem-modal').modal({"backdrop": false, "show": false, "keyboard": false });
  $('#fov-modal').modal({"backdrop": false, "show": false, "keyboard": true });
  $('#share-modal').modal({"backdrop": false, "show": false, "keyboard": true });
  $('#desdm-modal').modal({"backdrop": false, "show": false, "keyboard": true });
  $('#rank-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#mystats-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#congrats-modal').modal({"backdrop": false, "show":false, "keyboard": true});
  $('#message-modal').modal({"backdrop": true, "show":false, "keyboard": false});
  //$('#login-modal').modal({"backdrop": true, "show":false, "keyboard": false});
  
  // button actions
  $('button[class*="send"]').on('click', function(evt) {
    sendResponse();
  });
  $('#share-button').on('click', function() {
    $('#share-modal').modal('show');
    var textBox = $('#share-url');
    textBox.select();
    // Work around Chrome's little problem
    textBox.onmouseup = function() {
      // Prevent further mouseup intervention
      textBox.onmouseup = null;
      return false;
    };
  });
  $('#desdm-button').on('click', function() {
    $('#desdm-modal').modal('show');
    var textBox = $('#desdm-url');
    textBox.select();
    // Work around Chrome's little problem
    textBox.onmouseup = function() {
      // Prevent further mouseup intervention
      textBox.onmouseup = null;
      return false;
    };
  });
  $('#fov-button').on('click', function() {
    $('#fov-body').find('.fov-image').remove();
    $('<img class="fov-image" usemap="#ccdmap" src="'+ $('#fov-url').html() +'" border="0" />').load(function() {
      $(this).width(530).height(454).appendTo('#fov-body');
    });
    var new_url = window.location.pathname + "?release=" + release + "&expname=" + expname + "&ccd=";
    $('[name="ccdmap"]').find('.ccdshape').each(function() {
      var chipnum = this.title.split(" ").pop();
      $(this).attr('href', new_url + chipnum);
      if (chipnum == ccd) {
        console.log(chipnum);
        $(this).focus();
      }
    });
    $('#fov-modal').modal('show');
  });
  $('#reported-button').on('click', function() {
    var elem = $($(webfits.reportCtx)[0].canvas);
    // if new file: get reported problems
    if (has_reported_problems === false) {
      $('#loading').removeClass('hide');
      setTimeout(function() { // add a little timeout to give feedback to user
      $.get('problems.php', {'fileid': fileid , 'release': release}, function(response) {
          if (response) {
            for (var i=0; i < response.length; i++) {
              addMark(response[i], webfits.reportCtx);
            }
          }
          $('#loading').addClass('hide');
          has_reported_problems = true;
          elem.css('display', 'block');
        }, 'json');
      }, 500);
    }
    // toggle visibility of the canvas with the reported problems
    else {
      if (elem.css('display') == 'block')
        elem.css('display', 'none');
      else
        elem.css('display', 'block');
    }
  });
  $('#toggle-mask-button').on('click', function() {
    webfits.showMask = !webfits.showMask;
    webfits.draw();
  });
  $('#scaling-button').on('click', function() {
    stretch = (stretch == "arcsinh" ? "peter" : "arcsinh");
    webfits.setStretch(stretch);
  });
  $('#problem-text-button').on('click', function() {
    $('#problem-modal').modal('hide');
    var problemName = $('#problem-text').val();
    if (problemName.length > 11)
      problemName = problemName.substring(0,10) + "...";
    $('#problem-name').html(problemName);
  });
  $('a[class*="problem"]').on('click', function(evt) {
    problem = evt.target.innerHTML;
    $('#problem-name').html(problem);
    if (problem == "Other..." || problem == "Failure" || problem =="Awesome!") {
      $('#problem-modal').modal('show');
      $('#problem-text').val(''); // clear previous entry
      $('#problem-text').focus();
    } else {
      $('#problem-text').val('');
    }
  });
  $('#problem-close-button').on('click', function() {
    closeProblemModal();
  });
  $('#clear-button').on('click', function() {
    clearLastMark();
    if (marks.length == 0) {
      $('#mark-buttons').addClass('hide');
    }
  });
  
  // user requests
  $('#mystats-anchor').on('click', function() {
    getMyData();
    $('#mystats-modal').modal('show');
  });
  $('#leaderboard-anchor').on('click', function() {
    $.get('ranking.php', {'output': 'html', 'release': release}, function(response) {
      $('#rank-modal').find('[class*="modal-body"]').html(response);
      $('#rank-modal').modal('show');
    });
  });
  $('#logout').on('click', function() {
    $.post('login.php',{'logout':true}, function() {
      window.location.href="index.html";
      });
  });
  
  // key bindings
  jwerty.key('alt+l', function() {
    $('#share-button').trigger('click');  
  });
  jwerty.key('alt+d', function() {
    $('#desdm-button').trigger('click');  
  });
  jwerty.key('alt+m', function() {
    $('#toggle-mask-button').trigger('click');  
  });
  jwerty.key('alt+s', function() {
    $('#scaling-button').trigger('click');
  });
  jwerty.key('alt+f', function() {
    $('#fov-button').trigger('click');
  });
  jwerty.key('alt+r', function() {
    $('#squad-button').trigger('click');
  });
  jwerty.key('alt+p', function() {
    $('#reported-button').trigger('click');
  });

  // Enter and Esc for special keybindings inside the problem modal  
  $('#problem-modal').bind('keydown', jwerty.event('Enter', function () { $('#problem-text-button').trigger('click'); }));
  $('#problem-modal').bind('keydown', jwerty.event('Esc', function () { closeProblemModal(); }));
  
</script>
</html>
